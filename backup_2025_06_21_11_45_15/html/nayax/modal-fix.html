<!DOCTYPE html>
<html>
<head>
    <title>Discount Store Modal Fix</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .fix-container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .fix-button { background: #dc3545; color: white; border: none; padding: 15px 30px; border-radius: 5px; font-size: 18px; cursor: pointer; margin: 10px; }
        .fix-button:hover { background: #c82333; }
        .success { background: #28a745; }
        .success:hover { background: #218838; }
        .instructions { background: #e9ecef; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .code-block { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; font-family: monospace; font-size: 14px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="fix-container">
        <h1>üîß Discount Store Modal Fix</h1>
        <p>This page helps fix the "page goes dark and can't click anything" issue when trying to purchase discounts.</p>
        
        <div class="instructions">
            <h3>üìã Quick Instructions:</h3>
            <ol>
                <li><strong>If you're stuck right now:</strong> Click the red "Force Close Modal" button below</li>
                <li><strong>For future purchases:</strong> Copy the fix code and paste it in browser console</li>
                <li><strong>Alternative:</strong> Use the "Apply Permanent Fix" button</li>
            </ol>
        </div>
        
        <h3>üö® Emergency Fix (Use This If Stuck Now)</h3>
        <button class="fix-button" onclick="emergencyFix()">Force Close Modal</button>
        <button class="fix-button success" onclick="applyFix()">Apply Permanent Fix</button>
        
        <div id="status" style="margin: 20px 0; padding: 10px; border-radius: 5px; display: none;"></div>
        
        <h3>üíª Manual Fix Code (Copy & Paste in Console)</h3>
        <p>Press <strong>F12</strong> ‚Üí Go to <strong>Console</strong> tab ‚Üí Paste this code:</p>
        
        <div class="code-block">
// Emergency modal fix - paste this in browser console
document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
document.querySelectorAll('.modal').forEach(m => { m.style.display = 'none'; m.classList.remove('show'); });
document.body.classList.remove('modal-open');
document.body.style.overflow = '';
document.body.style.paddingRight = '';
console.log('‚úÖ Modal fixed!');
        </div>
        
        <h3>üîÑ Alternative Solutions</h3>
        <ul>
            <li><strong>Refresh the page</strong> - This usually fixes the issue</li>
            <li><strong>Press Escape key</strong> - Sometimes closes stuck modals</li>
            <li><strong>Go back in browser</strong> - Then return to the page</li>
            <li><strong>Clear browser cache</strong> - Fixes persistent issues</li>
        </ul>
        
        <h3>üéØ Permanent Fix for Purchase Buttons</h3>
        <p>This replaces the problematic modal with simple alerts that work reliably:</p>
        
        <div class="code-block" id="permanentFix" style="max-height: 300px; overflow-y: auto;">
// Permanent fix - replaces modal with alerts
window.purchaseDiscount = async function(itemId, itemName, price) {
    const button = event.target.closest('.purchase-btn');
    if (!button || button.disabled) return;
    
    const originalText = button.innerHTML;
    button.innerHTML = '‚è≥ Purchasing...';
    button.disabled = true;
    
    try {
        const response = await fetch('/html/api/purchase-discount.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                item_id: itemId,
                machine_id: new URLSearchParams(location.search).get('machine_id'),
                source: new URLSearchParams(location.search).get('source') || 'direct'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ Purchase Successful!\n\nDiscount Code: ${result.discount_code}\nDiscount: ${result.discount_percent}%\nExpires: ${new Date(result.expires_at).toLocaleDateString()}`);
            button.innerHTML = '‚úÖ Purchased';
            button.disabled = true;
        } else {
            throw new Error(result.error || 'Purchase failed');
        }
    } catch (error) {
        alert('‚ùå Purchase failed: ' + error.message);
        button.innerHTML = originalText;
        button.disabled = false;
    }
};
console.log('‚úÖ Purchase function fixed!');
        </div>
        
        <button class="fix-button success" onclick="copyCode()">üìã Copy Fix Code</button>
    </div>
    
    <script>
        function emergencyFix() {
            // Force close any stuck modals
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
                modal.classList.remove('show');
            });
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            showStatus('‚úÖ Emergency fix applied! Modals cleared.', 'success');
            
            // Try to close parent window modal if this was opened in a popup
            if (window.opener) {
                try {
                    window.opener.postMessage('closeModal', '*');
                } catch(e) {}
            }
        }
        
        function applyFix() {
            const fixCode = document.querySelector('#permanentFix').textContent;
            
            try {
                // Execute the fix code
                eval(fixCode);
                showStatus('‚úÖ Permanent fix applied! Purchase buttons will now use alerts instead of modals.', 'success');
            } catch (error) {
                showStatus('‚ùå Fix failed: ' + error.message, 'error');
            }
        }
        
        function copyCode() {
            const code = document.querySelector('#permanentFix').textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(code).then(() => {
                    showStatus('üìã Code copied to clipboard! Paste it in browser console (F12).', 'success');
                });
            } else {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showStatus('üìã Code copied! Paste it in browser console (F12).', 'success');
            }
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.display = 'block';
            status.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
            status.style.color = type === 'success' ? '#155724' : '#721c24';
            status.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
        
        // Listen for messages from parent window
        window.addEventListener('message', function(event) {
            if (event.data === 'closeModal') {
                emergencyFix();
            }
        });
    </script>
</body>
</html> 